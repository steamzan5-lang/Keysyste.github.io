-- SecureKey System - Roblox Client Script
-- This script handles key validation and user interface for the 24-hour key system

local Players = game:GetService("Players")
local HttpService = game:GetService("HttpService")
local DataStoreService = game:GetService("DataStoreService")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- Configuration
local API_BASE_URL = "https://your-vercel-domain.vercel.app" -- Replace with your actual domain
local KEY_DATASTORE_NAME = "SecureKeys"
local keyDataStore = DataStoreService:GetDataStore(KEY_DATASTORE_NAME)

-- Variables
local currentKey = nil
local isAuthenticated = false
local gui = nil

-- Create GUI Elements
local function createGUI()
    -- Main ScreenGui
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "SecureKeyGUI"
    screenGui.ResetOnSpawn = false
    screenGui.Parent = playerGui

    -- Main Frame
    local mainFrame = Instance.new("Frame")
    mainFrame.Name = "MainFrame"
    mainFrame.Size = UDim2.new(0, 400, 0, 300)
    mainFrame.Position = UDim2.new(0.5, -200, 0.5, -150)
    mainFrame.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    mainFrame.BorderSizePixel = 0
    mainFrame.Parent = screenGui

    -- Add corner rounding
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 12)
    corner.Parent = mainFrame

    -- Add shadow effect
    local shadow = Instance.new("Frame")
    shadow.Name = "Shadow"
    shadow.Size = UDim2.new(1, 6, 1, 6)
    shadow.Position = UDim2.new(0, -3, 0, -3)
    shadow.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    shadow.BackgroundTransparency = 0.8
    shadow.ZIndex = mainFrame.ZIndex - 1
    shadow.Parent = mainFrame

    local shadowCorner = Instance.new("UICorner")
    shadowCorner.CornerRadius = UDim.new(0, 12)
    shadowCorner.Parent = shadow

    -- Header
    local header = Instance.new("Frame")
    header.Name = "Header"
    header.Size = UDim2.new(1, 0, 0, 60)
    header.Position = UDim2.new(0, 0, 0, 0)
    header.BackgroundColor3 = Color3.fromRGB(59, 130, 246) -- primary-500
    header.BorderSizePixel = 0
    header.Parent = mainFrame

    local headerCorner = Instance.new("UICorner")
    headerCorner.CornerRadius = UDim.new(0, 12)
    headerCorner.Parent = header

    -- Fix corner for header bottom
    local headerBottomFix = Instance.new("Frame")
    headerBottomFix.Size = UDim2.new(1, 0, 0, 12)
    headerBottomFix.Position = UDim2.new(0, 0, 1, -12)
    headerBottomFix.BackgroundColor3 = Color3.fromRGB(59, 130, 246)
    headerBottomFix.BorderSizePixel = 0
    headerBottomFix.Parent = header

    -- Title
    local title = Instance.new("TextLabel")
    title.Name = "Title"
    title.Size = UDim2.new(1, -20, 1, 0)
    title.Position = UDim2.new(0, 10, 0, 0)
    title.BackgroundTransparency = 1
    title.Text = "üîë SecureKey System"
    title.TextColor3 = Color3.fromRGB(255, 255, 255)
    title.TextScaled = true
    title.Font = Enum.Font.SourceSansBold
    title.Parent = header

    -- Status Label
    local statusLabel = Instance.new("TextLabel")
    statusLabel.Name = "StatusLabel"
    statusLabel.Size = UDim2.new(1, -40, 0, 30)
    statusLabel.Position = UDim2.new(0, 20, 0, 80)
    statusLabel.BackgroundTransparency = 1
    statusLabel.Text = "Enter your 24-hour access key below:"
    statusLabel.TextColor3 = Color3.fromRGB(55, 65, 81) -- gray-700
    statusLabel.TextScaled = true
    statusLabel.Font = Enum.Font.SourceSans
    statusLabel.Parent = mainFrame

    -- Key Input TextBox
    local keyInput = Instance.new("TextBox")
    keyInput.Name = "KeyInput"
    keyInput.Size = UDim2.new(1, -40, 0, 40)
    keyInput.Position = UDim2.new(0, 20, 0, 120)
    keyInput.BackgroundColor3 = Color3.fromRGB(249, 250, 251) -- gray-50
    keyInput.BorderColor3 = Color3.fromRGB(209, 213, 219) -- gray-300
    keyInput.BorderSizePixel = 1
    keyInput.Text = ""
    keyInput.PlaceholderText = "Enter access key (16 characters)"
    keyInput.TextColor3 = Color3.fromRGB(17, 24, 39) -- gray-900
    keyInput.TextScaled = true
    keyInput.Font = Enum.Font.SourceSansLight
    keyInput.ClearTextOnFocus = false
    keyInput.Parent = mainFrame

    local inputCorner = Instance.new("UICorner")
    inputCorner.CornerRadius = UDim.new(0, 6)
    inputCorner.Parent = keyInput

    -- Submit Button
    local submitButton = Instance.new("TextButton")
    submitButton.Name = "SubmitButton"
    submitButton.Size = UDim2.new(1, -40, 0, 40)
    submitButton.Position = UDim2.new(0, 20, 0, 180)
    submitButton.BackgroundColor3 = Color3.fromRGB(59, 130, 246) -- primary-500
    submitButton.BorderSizePixel = 0
    submitButton.Text = "Verify Key"
    submitButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    submitButton.TextScaled = true
    submitButton.Font = Enum.Font.SourceSansSemibold
    submitButton.Parent = mainFrame

    local buttonCorner = Instance.new("UICorner")
    buttonCorner.CornerRadius = UDim.new(0, 6)
    buttonCorner.Parent = submitButton

    -- Get Key Button
    local getKeyButton = Instance.new("TextButton")
    getKeyButton.Name = "GetKeyButton"
    getKeyButton.Size = UDim2.new(1, -40, 0, 30)
    getKeyButton.Position = UDim2.new(0, 20, 0, 240)
    getKeyButton.BackgroundColor3 = Color3.fromRGB(107, 114, 128) -- gray-500
    getKeyButton.BorderSizePixel = 0
    getKeyButton.Text = "Get New Key (Opens Website)"
    getKeyButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    getKeyButton.TextScaled = true
    getKeyButton.Font = Enum.Font.SourceSans
    getKeyButton.Parent = mainFrame

    local getKeyCorner = Instance.new("UICorner")
    getKeyCorner.CornerRadius = UDim.new(0, 6)
    getKeyCorner.Parent = getKeyButton

    -- Add hover effects
    local function addHoverEffect(button, normalColor, hoverColor)
        button.MouseEnter:Connect(function()
            local tween = TweenService:Create(button, TweenInfo.new(0.2), {BackgroundColor3 = hoverColor})
            tween:Play()
        end)
        
        button.MouseLeave:Connect(function()
            local tween = TweenService:Create(button, TweenInfo.new(0.2), {BackgroundColor3 = normalColor})
            tween:Play()
        end)
    end

    addHoverEffect(submitButton, Color3.fromRGB(59, 130, 246), Color3.fromRGB(37, 99, 235)) -- primary-600
    addHoverEffect(getKeyButton, Color3.fromRGB(107, 114, 128), Color3.fromRGB(75, 85, 99)) -- gray-600

    return screenGui, mainFrame, statusLabel, keyInput, submitButton, getKeyButton
end

-- Verify key with API
local function verifyKey(key)
    local success, result = pcall(function()
        local url = API_BASE_URL .. "/api/verify?key=" .. HttpService:UrlEncode(key)
        local response = HttpService:GetAsync(url)
        return HttpService:JSONDecode(response)
    end)
    
    if success and result then
        return result.status
    else
        warn("Failed to verify key:", result)
        return "invalid"
    end
end

-- Save key to DataStore
local function saveKey(key)
    local success, errorMsg = pcall(function()
        keyDataStore:SetAsync(player.UserId, key)
    end)
    
    if not success then
        warn("Failed to save key:", errorMsg)
    end
end

-- Load key from DataStore
local function loadKey()
    local success, result = pcall(function()
        return keyDataStore:GetAsync(player.UserId)
    end)
    
    if success then
        return result
    else
        warn("Failed to load key:", result)
        return nil
    end
end

-- Remove key from DataStore
local function removeKey()
    local success, errorMsg = pcall(function()
        keyDataStore:RemoveAsync(player.UserId)
    end)
    
    if not success then
        warn("Failed to remove key:", errorMsg)
    end
end

-- Update GUI status
local function updateStatus(text, color)
    if gui and gui.Parent then
        local statusLabel = gui:FindFirstChild("MainFrame"):FindFirstChild("StatusLabel")
        if statusLabel then
            statusLabel.Text = text
            statusLabel.TextColor3 = color or Color3.fromRGB(55, 65, 81)
        end
    end
end

-- Hide GUI with animation
local function hideGUI()
    if gui and gui.Parent then
        local mainFrame = gui:FindFirstChild("MainFrame")
        if mainFrame then
            local tween = TweenService:Create(mainFrame, TweenInfo.new(0.5, Enum.EasingStyle.Back, Enum.EasingDirection.In), {
                Size = UDim2.new(0, 0, 0, 0),
                Position = UDim2.new(0.5, 0, 0.5, 0)
            })
            tween:Play()
            
            tween.Completed:Connect(function()
                gui:Destroy()
                gui = nil
            end)
        end
    end
end

-- Show GUI with animation
local function showGUI()
    if gui and gui.Parent then
        local mainFrame = gui:FindFirstChild("MainFrame")
        if mainFrame then
            mainFrame.Size = UDim2.new(0, 0, 0, 0)
            mainFrame.Position = UDim2.new(0.5, 0, 0.5, 0)
            
            local tween = TweenService:Create(mainFrame, TweenInfo.new(0.5, Enum.EasingStyle.Back, Enum.EasingDirection.Out), {
                Size = UDim2.new(0, 400, 0, 300),
                Position = UDim2.new(0.5, -200, 0.5, -150)
            })
            tween:Play()
        end
    end
end

-- Main script execution function
local function executeMainScript()
    print("üîë SecureKey System: Access granted! Running main script...")
    -- üöÄ PUT YOUR MAIN SCRIPT LOGIC HERE
    -- This is where your protected code should go
    
    -- Example:
    updateStatus("‚úÖ Access granted! Script is running...", Color3.fromRGB(34, 197, 94)) -- green-500
    wait(2)
    hideGUI()
    
    -- Your actual script functionality goes here
    print("Main script is now running with verified access!")
end

-- Handle key submission
local function handleKeySubmission(key)
    if not key or key == "" then
        updateStatus("‚ùå Please enter a key", Color3.fromRGB(239, 68, 68)) -- red-500
        return
    end
    
    if string.len(key) ~= 16 then
        updateStatus("‚ùå Key must be exactly 16 characters", Color3.fromRGB(239, 68, 68))
        return
    end
    
    updateStatus("‚è≥ Verifying key...", Color3.fromRGB(59, 130, 246)) -- primary-500
    
    local status = verifyKey(key)
    
    if status == "valid" then
        currentKey = key
        isAuthenticated = true
        saveKey(key)
        updateStatus("‚úÖ Key verified! Starting script...", Color3.fromRGB(34, 197, 94))
        wait(1)
        executeMainScript()
    elseif status == "expired" then
        removeKey()
        updateStatus("‚è∞ Key has expired. Please get a new key.", Color3.fromRGB(245, 158, 11)) -- amber-500
    else
        updateStatus("‚ùå Invalid key. Please check and try again.", Color3.fromRGB(239, 68, 68))
    end
end

-- Initialize the system
local function initialize()
    print("üîë SecureKey System: Initializing...")
    
    -- Check for existing key
    local savedKey = loadKey()
    
    if savedKey then
        print("Found saved key, verifying...")
        local status = verifyKey(savedKey)
        
        if status == "valid" then
            currentKey = savedKey
            isAuthenticated = true
            executeMainScript()
            return
        elseif status == "expired" then
            print("Saved key has expired, removing...")
            removeKey()
        else
            print("Saved key is invalid, removing...")
            removeKey()
        end
    end
    
    -- Show GUI for key input
    local screenGui, mainFrame, statusLabel, keyInput, submitButton, getKeyButton = createGUI()
    gui = screenGui
    
    showGUI()
    
    -- Connect button events
    submitButton.MouseButton1Click:Connect(function()
        handleKeySubmission(keyInput.Text)
    end)
    
    -- Handle Enter key press
    keyInput.FocusLost:Connect(function(enterPressed)
        if enterPressed then
            handleKeySubmission(keyInput.Text)
        end
    end)
    
    -- Get key button (opens website)
    getKeyButton.MouseButton1Click:Connect(function()
        print("Opening key generation website...")
        updateStatus("üåê Check your browser for the key website", Color3.fromRGB(59, 130, 246))
        
        -- Copy website URL to clipboard (if possible) or show in console
        local websiteUrl = API_BASE_URL
        print("üîó Website URL: " .. websiteUrl)
        print("üí° Copy this URL and paste it in your browser to get a new key")
    end)
end

-- Auto-start when script loads
spawn(function()
    wait(1) -- Brief delay to ensure everything is loaded
    initialize()
end)

-- Handle player leaving (cleanup)
game.Players.PlayerRemoving:Connect(function(leavingPlayer)
    if leavingPlayer == player then
        if gui then
            gui:Destroy()
        end
    end
end)

print("üîë SecureKey System: Script loaded successfully!")
